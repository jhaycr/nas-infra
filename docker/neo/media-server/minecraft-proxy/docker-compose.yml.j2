---
networks:
  minecraft:
    driver: bridge

services:

  # TODO: https://github.com/vpathuis/multiple-minecraft-bedrock-docker/blob/main/docker-compose.yml

  minecraft-proxy:
    image: itzg/mc-proxy
    container_name: minecraft-proxy
    hostname: mc
    environment:
      TYPE: "VELOCITY"
      VELOCITY_VERSION: "3.4.0"
      # VELOCITY_BUILD_ID: "latest"

      # Auto-download plugins via URLs
      PLUGINS: |
        https://download.geysermc.org/v2/projects/geyser/versions/latest/builds/latest/downloads/velocity
        https://download.geysermc.org/v2/projects/floodgate/versions/latest/builds/latest/downloads/velocity
    volumes:
      - {{ docker_appdata_path }}/minecraft-proxy:/server
      #- {{ docker_appdata_path }}/minecraft-proxy/velocity-data/velocity.toml:/server/velocity.toml
      #- {{ docker_appdata_path }}/minecraft-proxy/velocity-data/forwarding.secret:/server/forwarding.secret:ro
    networks:
      - minecraft
    ports:
      - "25565:25565"
      - "19132:19132/udp"

  tailscale-minecraft:
    image: tailscale/tailscale:v1.94.2
    network_mode: "service:minecraft-proxy"
    depends_on:
      - minecraft-proxy
    environment:
      - TS_AUTHKEY={{ secret_tailscale_auth_key_minecraft}}
      - TS_EXTRA_ARGS=--advertise-tags=tag:minecraft-server
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - {{ docker_appdata_path }}/tailscale-minecraft/state:/var/lib/tailscale
      # - ${PWD}/tailscale-nginx/state:/var/lib/tailscale
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
    restart: unless-stopped